---
title: 跨站点授权
author: yrobot
keywords: Nodejs,cross-site,auth,server,跨站点,授权,login,登陆,账户体系
createTime: 2021年08月09日
draft: true
---

## 前言

本文主要是为了调研实现跨站点认证的技术基础。  
包括是否必须 iframe 来实现跨站携带同一认证，iframe 中跨站认证的实现方案可行性。

如，`auth.com` 作为统一认证服务，`b.com` 作为业务一的域名，`c.com` 作为业务二的域名，而且 b 和 c 的业务共用 auth 账号体系。

- 是否可以直接在 `b.com` 中通过请求 `auth.com` 的接口获取认证 token，同理 `c.com`。业务 server 层直接请求 `auth.com` 获取 key 之后对 token 进行校验，管理账号直接请求 auth 服务 来实现账号体系的复用。

- 在业务 server 中，遇到需要更多用户信息的场景时，支持从 Auth Server 获取所需数据

对内的认证系统，可以直接暴露内网接口，不用担心信息的泄露。对外的认证系统，需要更细致全面的权限认证。  
本文主要探讨对内的认证系统，即对于业务服务具有较高的信任度。

## 跨域问题

涉及到多个域名，当然离不开浏览器跨域问题。  
关于跨域问题和解决方案请参看之前的 blog [《跨域问题》](../浏览器/跨域问题)

**强烈建议先搞清楚跨域问题后再进行下文的阅读**

## 由于跨域导致的问题

无法在 `b.com` 和 `c.com` 直接请求 `auth.com`，且浏览器本地登录状态无法跨域共享

## 可行方案罗列与优缺点分析

### 1. CORS + 正向代理，利用 cookies 等手段储存登录状态

> 此方案思路是让业务网站可以直接请求 auth server

方案流程：

1. auth server 配置 cors 白名单支持业务网站跨域请求。
2. 业务网站正向代理 auth 请求

利用 auth 请求的 cookies 储存登录状态和信息

#### 优势

1. 方案直观：配置跨域之后，可以像正常请求一样和 auth server 进行通信

#### 劣势

1. 跨域 cookies 存在限制：参看 [《跨域问题 #浏览器的跨域限制有哪些》](../浏览器/跨域问题#浏览器的跨域限制有哪些)
2. 业务和认证耦合：认证能力升级后需要业务项目更新
3. 认证数据存储受限：由于通过 cookies 储存认证信息，所以认证信息存储受限于 cookies
4. 流程偏长：后续网站自动登录需要通过再次请求

### 2. 利用 iframe 作为中间人，使用 window.postMessage 实现跨域通讯，避免直接跨域请求

> 此方案利用 iframe + postMessage，避免跨域请求，并利用 auth 域的 localStorage 进行认证信息存储

方案流程：

1. 业务网站实例化 auth iframe
2. iframe 处理所有 auth 相关的数据请求和存储
3. 业务页面 通过 postMessage 和 iframe 进行跨域信息互通

#### 优势

1. 方案安全：postMessage 的作用就是**安全地实现跨源通信**，且方案中请求不跨域。不用担心方案失效
2. 存储无限制：直接利用 auth origin 下的 localStorage 进行存储
3. 认证系统可以无感升级：auth iframe 的升级不会影响业务逻辑
4. 实时同步认证信息：多个 auth iframe 间可以通过 `window.addEventListener('storage')`进行消息同步

#### 劣势

1. 理解成本高：引入了 iframe，不直观
2. auth iframe 样式难以个性化：业务逻辑难以个性化 auth iframe 里的节点样式

### 3. 业务 server 反向代理 auth 服务

> 利用业务 server 方向代理 auth 请求，来规避跨域请求问题

方案流程：

1. 业务 server 对于某个规则的请求进行转发到 auth server。
2. 业务 client 直接利用业务域名进行认证请求

#### 优势

1. 方案直观：client 直接和业务 server 通讯

#### 劣势

1. 无法同步认证状态：所有的 auth 请求都合并到了业务请求中，client 端无法共享认证信息
2. 业务和认证耦合：认证能力升级后需要业务项目更新

## 最优方案选择和细节设计

综上所述，我更偏向于使用 iframe + postMessage 的方案。  
此方案的缺点影响对于我来说影响是最低的。

整体方案定了之后，需要对实现细节进行设计，来实现业务端最优的使用体验

### 认证系统需处理的内容

1. 

---

### 业务层面

期望目标是，a b 网站共用用户系统，包括通用的用户信息等，  
并且，在 a 登录之后，b 网站聚焦后自动已登陆。

### 技术层面

直接通过 npm 安装 认证 client 端的通用逻辑，
解藕认证系统逻辑，业务端无需考虑认证系统的修改。
