---
title: 跨站请求携带认证
author: yrobot
keywords: 浏览器,跨域,auth,token,cross-origin,iframe
createTime: 2021年08月10日
updateTime: 2021年08月12日
---

## 前言

本文主要是为了调研实现跨站点认证的技术基础。包括是否必须 iframe 来实现跨站携带同一认证，iframe 中跨站认证的实现方案可行性。

如，`auth.com` 作为统一认证服务，`b.com` 作为业务一的域名，`c.com` 作为业务二的域名，而且 b 和 c 的业务共用 auth 账号体系。

- 是否可以直接在 `b.com` 中通过请求 `auth.com` 的接口获取认证 token，同理 `c.com`。业务 server 层直接请求 `auth.com` 获取 key 之后对 token 进行校验，管理账号直接请求 auth 服务 来实现账号体系的复用。

- 在业务 server 中，遇到需要更多用户信息的场景时，支持通过请求等方式从 Auth Server 获取所需数据

## 跨域问题

涉及到多个域名，当然离不开浏览器跨域问题。  
关于跨域问题和解决方案请参看之前的 blog [《跨域问题》](./跨域问题)  
**强烈建议先搞清楚跨域问题后再进行下文的阅读**

## 由于跨域导致的问题

无法在 `b.com` 和 `c.com` 直接请求 `auth.com`

## 解决方案设计

方案的设计时主要还得考虑对于业务 server 的信任度。对于内部业务系统，当然就可以直接暴露请求，不用担心信息的泄露。对外的认证系统，需要更细致全面的权限认证。

### 对内认证系统

> 由于对业务 server 的完全信任，所以仅从可行性和 Client 端安全性设计即可

主要解决两个问题：

1. Client 支持从 auth 系统实现注册登录
2. Server 端支持对账号信息的获取

设计：

1. 利用域名白名单，实现 Client 跨域注册登录，auth 系统提供前端组件库来处理客户端 auth 逻辑的交互。
2. 首先业务 server 可以获取 token decode 时的 key 来验证 token
   信息，从而获取用户基础信息。如果需要更多的用户信息，Auth server 也支持提供给 API 供业务 server 请求（接口内网暴露）

### 对外认证系统

牵扯到更细致的安全设计，后期持续更新。

## 实现跨站点登陆状态同步

期望的实现效果，类似于 当你登陆了淘宝之后，再打开天猫的页面，你会发现已经自动登录了天猫。

这涉及到了进一步的跨域问题，即在跨域请求时自动携带 cookie。但是最近几年浏览器升级了对 CSRF 的防御策略，从而导致了跨域携带 cookie 的难度又上升了。

#### 近几年浏览器对于 CSRF 的防御提升，跨域请求携带 cookie 存在限制

> 下图是我用常规手段配置跨域后，设置 cookie 时 chorme 的错误提示：

<img src='https://image.yrobot.top:4433/2021/08/13/1628848854.png' width='500'/>

总结来说，新版 Chrome（Chrome 80+）会对跨域请求携带 cookie 进行以下校验，只有全通过后才可以跨域携带 cookie：

1. 服务端 cookie 设置 SameSite=None
2. 服务端 cookie 设置 Secure
3. 请求通过 https 协议进行

#### session 面临和 cookie 同样的问题

同理，由于 session 的原理是将 session key 存放在 cookie 中，根据 key 从 server 端获取对应的 session 数据，所以本质上通讯原理和 cookie 是一致的。所以 session 同样会面临上述的问题。

#### 通过 iframe 规避跨域带来的问题

<img src='https://image.yrobot.top:4433/2021/08/15/1629004609.png' width='600'/>

> 通过 iframe 规避浏览器对于跨域请求的限制，跨域的数据交互通过 postMessage 进行

Iframe code: auth.html

```html
<script>
  const login = (data = {}) =>
    fetch("https://www.auth.com/login", {
      headers: {
        "content-type": "application/json",
        token: localStorage.getItem("token") || "",
      },
      body: JSON.stringify(data), // must match 'Content-Type' header
      method: "POST", // *GET, POST, PUT, DELETE, etc.
    })
      .then(function (response) {
        return response.json();
      })
      .then(function (res) {
        const { token } = res?.data || {};
        localStorage.setItem("token", token);
        return res?.data;
      });

  const getInfo = (data = {}) =>
    fetch("https://www.auth.com/info", {
      headers: {
        "content-type": "application/json",
        token: localStorage.getItem("token") || "",
      },
      method: "POST", // *GET, POST, PUT, DELETE, etc.
    })
      .then(function (response) {
        return response.json();
      })
      .then(function (res) {
        return res?.data;
      });

  const logout = () => {
    localStorage.removeItem("token");
  };

  window.addEventListener(
    "message",
    async function (event) {
      const { type } = event.data || {};
      var res;
      switch (type) {
        case "LOGIN":
          res = await login({
            username: "username",
            password: "password",
          });
          break;
        case "INFO":
          res = await getInfo();
          break;
        case "LOGOUT":
          logout();
          break;
      }
      event.source.postMessage(
        {
          type,
          data: res,
        },
        "*"
      );
    },
    false
  );
</script>
```

Business code:

```html
<iframe
  src="https://www.auth.com/auth.html"
  style="position: absolute;width: 1px;height: 1px;"
  id="auth-iframe"
  frameborder="0"
></iframe>
<script>
  const iframeWindow = document.getElementById("auth-iframe").contentWindow;

  const login = () => {
    iframeWindow.postMessage(
      {
        type: "LOGIN",
      },
      "https://www.auth.com"
    );
  };

  const info = () => {
    iframeWindow.postMessage(
      {
        type: "INFO",
      },
      "https://www.auth.com"
    );
  };

  const logout = () => {
    iframeWindow.postMessage(
      {
        type: "LOGOUT",
      },
      "https://www.auth.com"
    );
  };
</script>
```

## 对于易用性的思考

> 由于 auth 系统独立于业务系统之外，所以如果 auth 系统升级可以做到业务项目无感，这是最理想的情况。

<!-- 下面我们来进一步优化一下实现方案 -->
